{% extends "base.html" %}

#TODO: remove CDN and replace it with local static
{% block head_scripts %}
  <!-- <script src="{{ url_for('static', filename='/vendor/jquery/jquery.min.js') }}"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block flash_messages %}
{% endblock %}

{% block content %}
    <div class="d-flex flex-column justify-content-center w-100">

      <!-- Status header -->
      {% if "red" in computer.alert_status %}
        <div
          class="d-flex align-items-center justify-content-center text-white w-100"
          style="background-color: #e74a3b; padding: 10px 0;"
        >
          <span style="font-size: 25px;">{{ computer.alert_status.replace("red - ", "").capitalize() }}</span>
        </div>
      {% elif "yellow" in computer.alert_status %}
        <div
          class="d-flex align-items-center justify-content-center text-white w-100"
          style="background-color: #f6c23e; padding: 10px 0;"
        >
          <span style="font-size: 25px;">{{ computer.alert_status.replace("yellow - ", "").capitalize() }}</span>
        </div>
      {% elif "green" in computer.alert_status %}
        <div
          class="d-flex align-items-center justify-content-center text-white w-100"
          style="background-color: #1cc88a; padding: 10px 0;"
        >
          <span style="font-size: 25px;">Online</span>
        </div>
      {% endif %}
      <!-- End status header -->

      <!-- Computer info -->
      <div class="d-flex w-100 p-4">
        <div class="d-flex w-100 flex-column justify-content-center m-3">
          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Company</span>
            <span class="border rounded mb-3">{{ computer.company.name }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Computer Name</span>
            <span class="border rounded mb-3">{{ computer.computer_name }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Computer IP Address</span>
            <span class="border rounded mb-3">{{ computer.computer_ip }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Last Download Time</span>
            <span class="border rounded mb-3">{{ computer.last_download_time }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Software Version</span>
            <span class="border rounded mb-3">{{ computer.current_msi_version }}</span>
          </div>
        </div>

        <div class="d-flex w-100 flex-column justify-content-center m-3">
          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Location</span>
            <span class="border rounded mb-3">{{ computer.location.name }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Device Type</span>
            <span class="border rounded mb-3">{{ computer.type }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Last Time Online</span>
            <span class="border rounded mb-3">{{ computer.last_time_online }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Download File Location</span>
            <span class="border rounded mb-3">{{ computer.last_downloaded }}</span>
          </div>

          <div class="d-flex flex-column justify-content-start">
            <span class="text-grey mb-1">Device Added</span>
            <span class="border rounded mb-3">{{ computer.created_at }}</span>
          </div>
        </div>
      </div>
      <!-- End computer info -->

      <!-- Online / offline periods chart -->
      <div class="d-flex flex-column w-100 justify-content-center mb-4">
        <div class="d-flex w-100 justify-content-center">
          <div class="text-grey mb-1 d-flex align-items-center">
            Online / Offline periods per last
            <div class="dropdown mr-1 ml-1">
              <button class="btn border-dark dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {{ chart_days }}
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                {% for days_number in [1, 3, 7, 10, 30] %}
                  <a class="dropdown-item" href="{{ url_for('info.computer_info', computer_id=computer.id) }}?chart_days={{ days_number }}">{{days_number}}</a>
                {% endfor %}
              </div>
            </div>
            {{ "day" if chart_days == 1 else "days" }}
          </div>
        </div>

        <div class="d-flex justify-content-center pr-5 pl-5" style="height: 300px">
          <canvas id="periodsChart">
            <p>Just some text...</p>
          </canvas>

          <script>
            const ctx = document.getElementById('periodsChart');
            const notes = {{ chart_notes | tojson }};
            const greenDataArray = {{ chart_green_data | tojson }};
            const yellowDataArray = {{ chart_yellow_data | tojson }};
            const redDataArray = {{ chart_red_data | tojson }};
            // console.log(notes);

            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: [
                  {% for label in labels %}
                    '{{ label.strftime("%Y-%m-%d %H:%M:%S") }}',
                  {% endfor %}
                ],
                datasets: [
                  {
                    label: "Online",
                    barPercentage: 1,
                    categoryPercentage: 1,
                    borderSkipped: true,
                    backgroundColor: "rgb(28, 200, 138 ,0.7)",
                    hoverBackgroundColor: "rgb(28, 200, 138 ,1)",
                    data: greenDataArray,
                    borderWidth: 1,
                    order: 3,
                    pointStyle: false,
                    skipNull: true,
                  },
                  {
                    label: "Offline over 1 hour",
                    barPercentage: 1,
                    categoryPercentage: 1,
                    borderSkipped: true,
                    backgroundColor: "rgb(246, 194, 62, 0.7)",
                    hoverBackgroundColor: "rgb(246, 194, 62, 1)",
                    data: yellowDataArray,
                    borderWidth: 1,
                    order: 2,
                    pointStyle: false,
                    skipNull: true,
                  },
                  {
                    label: "Offline over 2 hours",
                    barPercentage: 1,
                    categoryPercentage: 1,
                    borderSkipped: true,
                    backgroundColor: "rgb(231, 74, 59, 0.7)",
                    data: redDataArray,
                    borderWidth: 1,
                    order: 1,
                    pointStyle: false,
                    skipNull: true,
                  },
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    display: false
                  },
                  x: {
                    grid: {
                      drawTicks: false,
                    },
                    // type: 'time',
                    // display: false,
                    ticks: {
                      // maxRotation: 0,
                      maxTicksLimit: 5,
                    },
                  },
                },
                plugins: {
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const label = context.dataset.label;
                              return label;
                          },
                          afterLabel: function(context) {
                              if (context.raw === null || context.dataset.label === "Online") {
                                return null
                              }

                              const note = notes[context.dataIndex];
                              return `Note: ${note}`;
                          }
                      }
                  }
                }
              }
            });
          </script>
        </div>
      </div>
      <!-- End online / offline periods chart -->

      <!-- Backup periods logs table -->
      <div class="d-flex w-100 p-4 justify-content-center">
        {% if not logs %}
          <span>This device currently has no logs</span>
        {% else %}
          <div>
            <div>
              <table class="w-full text-xs text-center table-bordered">
                <thead class="text-sm text-center thead-light" >
                  <tr>
                    <th scope="col">Status</th>
                    <th scope="col">Device Name</th>
                    <th scope="col">Start Time</th>
                    <th scope="col">End Time</th>
                    <th scope="col">Duration</th>
                    <th scope="col">Error</th>
                    <th scope="col">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs %}
                  <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" >
                    <td>
                      <div class="flex items-center content-center">
                        {% if log.error == "" %}
                          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="20px" width="20px" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 122.88 109.76" style="enable-background:new 0 0 122.88 109.76" xml:space="preserve">
                            <style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;fill:#01A601;}</style>
                            <g>
                              <path class="st0" d="M0,52.88l22.68-0.3c8.76,5.05,16.6,11.59,23.35,19.86C63.49,43.49,83.55,19.77,105.6,0h17.28 C92.05,34.25,66.89,70.92,46.77,109.76C36.01,86.69,20.96,67.27,0,52.88L0,52.88z"/>
                            </g>
                          </svg>
                        {% elif log.error == "Longer than 1 hour without a backup" %}
                          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="20px" width="20px" version="1.1" id="_x32_" viewBox="0 0 512 512" xml:space="preserve">
                            <g>
                              <path fill="#f6c23e" d="M505.095,407.125L300.77,53.208c-9.206-15.944-26.361-25.849-44.774-25.849   c-18.412,0-35.552,9.905-44.751,25.849L6.905,407.109c-9.206,15.944-9.206,35.746,0,51.69   c9.206,15.944,26.354,25.842,44.758,25.842h408.674c18.405,0,35.568-9.897,44.759-25.842   C514.302,442.855,514.302,423.053,505.095,407.125z M256.004,426.437c-17.668,0-32.013-14.33-32.013-32.004   c0-17.668,14.345-31.997,32.013-31.997c17.667,0,31.997,14.329,31.997,31.997C288.001,412.108,273.671,426.437,256.004,426.437z    M275.72,324.011c0,10.89-8.834,19.709-19.716,19.709c-10.898,0-19.717-8.818-19.717-19.709l-12.296-144.724   c0-17.676,14.345-32.005,32.013-32.005c17.667,0,31.997,14.33,31.997,32.005L275.72,324.011z"/>
                            </g>
                          </svg>
                        {% elif log.error == "Longer than 2 hours without a backup" %}
                          <svg xmlns="http://www.w3.org/2000/svg" fill="#e74a3b" width="20px" height="20px" viewBox="0 0 16 16">
                            <path d="M0 14.545L1.455 16 8 9.455 14.545 16 16 14.545 9.455 8 16 1.455 14.545 0 8 6.545 1.455 0 0 1.455 6.545 8z" fill-rule="evenodd"/>
                          </svg>
                        {% endif %}
                      </div>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                        <div class="text-base font-semibold">{{ log.computer.computer_name }}</div>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                      <span class="text-base font-semibold">{{ log.est_start_time }}</span>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                      <span class="text-base font-semibold">{{ log.est_end_time }}</span>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                      <div class="text-base font-semibold">{{ log.duration_as_str }}</div>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                      <div class="text-base font-semibold">{{ log.error }}</div>
                    </td>
                    <td class="p-2 text-base font-normal text-gray-900 whitespace-nowrap dark:text-white">
                      <div class="text-base font-semibold">{{ log.notes }}</div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            {% if page.pages > 1 %}
              <div class="d-flex justify-content-center mt-1">
                <nav aria-label="Page navigation" class="mx-auto">
                  <ul class="d-inline-flex items-center list-unstyled">
                    <li>
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page=1" class="text-gray-500">
                        <span class="sr-only">First</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20px" height="20px">
                          <path fill-rule="evenodd" d="M15.79 14.77a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L11.832 10l3.938 3.71a.75.75 0 01.02 1.06zm-6 0a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L5.832 10l3.938 3.71a.75.75 0 01.02 1.06z" clip-rule="evenodd" />
                        </svg>
                      </a>
                    </li>
                    <li>
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page={{page.page-1 if page.page > 1 else 1}}" class="text-gray-500">
                        <span class="sr-only">Previous</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20px" height="20px">
                          <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                        </svg>
                      </a>
                    </li>

                    <!-- prettier-ignore -->
                    {% for p in page.pages_for_links %}
                    <li>
                      <!-- prettier-ignore -->
                      {% if p == page.page %}
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page={{p}}" class="m-1 text-gray-700">{{p}}</a>
                      {% else %}
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page={{p}}" class="m-1 text-gray-500">{{p}}</a>
                      {% endif %}
                    </li>
                    {% endfor %}

                    <li>
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page={{page.page+1 if page.page < page.pages else page.pages}}" class="text-gray-500">
                        <!-- prettier-ignore -->
                        <span class="sr-only">Next</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20px" height="20px">
                          <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                        </svg>
                      </a>
                    </li>
                    <li>
                      <!-- prettier-ignore -->
                      <a href="{{ url_for('info.computer_info', computer_id=computer.id) }}?page={{page.pages}}" class="text-gray-500">
                        <!-- prettier-ignore -->
                        <span class="sr-only">Last</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20px" height="20px">
                          <path fill-rule="evenodd" d="M10.21 14.77a.75.75 0 01.02-1.06L14.168 10 10.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                          <path fill-rule="evenodd" d="M4.21 14.77a.75.75 0 01.02-1.06L8.168 10 4.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                        </svg>
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
{% endblock %}

{% block sidebar_toggle %}
  <script>
    document.addEventListener("DOMContentLoaded",
      function(){
        $("#sidebarToggle").click();
      });
  </script>
{% endblock sidebar_toggle %}

{% block bootstrap_core %}
  <!-- This if statement is required to avoid double import if jQuery. Otherwise some funtions brake -->
  <script src="{{ url_for('static', filename='/vendor/jquery/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='/vendor/jquery/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='/vendor/jquery/popper.min.js.map') }}"></script>
{% endblock bootstrap_core %}
